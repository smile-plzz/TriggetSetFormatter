<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Product Explorer – Enhanced + Paste</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <style>
    :root {
      --bg: #f7f7fb; --fg: #0f172a; --muted: #6b7280; --card: #fff; --border: #e5e7eb; --accent: #2563eb;
      --success: #166534; --danger: #991b1b; --warning: #b45309;
    }
    [data-theme="dark"] {
      --bg: #0f172a; --fg: #f1f5f9; --muted: #94a3b8; --card: #1e293b; --border: #334155;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; color:var(--fg); background:var(--bg); transition: background 0.2s, color 0.2s; }
    .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
    @media (min-width: 768px) { .container { padding: 24px; } }
    header { display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap: 12px; margin-bottom: 16px; }
    h1 { font-size: 24px; margin: 0; }
    @media (min-width: 640px) { h1 { font-size: 26px; } }
    p.muted { color: var(--muted); margin: 4px 0 0; font-size: 14px; }
    .row { display:grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 1px 2px rgba(0,0,0,.03); }
    .pad { padding: 16px; }
    .btn {
      display:inline-flex; gap:8px; align-items:center; padding: 8px 12px; border: 1px solid var(--border); background: #fff; border-radius: 999px; cursor: pointer; font-size: 14px; transition: all 0.2s;
    }
    [data-theme="dark"] .btn { background: #334155; border-color: #475569; color: #e2e8f0; }
    .btn:hover { background: #f3f4f6; }
    [data-theme="dark"] .btn:hover { background: #475569; }
    .btn[disabled] { opacity: 0.5; cursor:not-allowed; }
    .btn.sm { padding: 6px 10px; font-size: 13px; }
    .btn.danger { color: var(--danger); border-color: #fca5a5; }
    .btn.danger:hover { background: #fee2e2; }
    .controls label { font-size: 13px; color: var(--muted); display:block; margin-bottom:6px; font-weight: 500; }
    input[type='text'], input[type='number'], select, textarea {
      width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:12px; background:var(--card); color:var(--fg); font-size: 14px;
    }
    textarea { min-height: 120px; font-family: monospace; resize: vertical; }
    table { width:100%; border-collapse: collapse; font-size: 14px; }
    thead th {
      position: sticky; top: 0; background: #f3f4f6; text-align:left; padding:10px; border-bottom:1px solid var(--border); white-space:nowrap; cursor: pointer; user-select: none; font-weight: 600;
    }
    [data-theme="dark"] thead th { background: #334155; }
    thead th:hover { background: #e5e7eb; }
    [data-theme="dark"] thead th:hover { background: #475569; }
    thead th::after { content: " up-down"; opacity: 0.3; font-size: 12px; }
    tbody td { padding:8px 10px; border-bottom:1px solid var(--border); vertical-align: top; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; margin:0 4px 4px 0; font-size: 12px; }
    .chips { display:flex; flex-wrap: wrap; gap: 6px; max-height: 140px; overflow:auto; padding: 4px 0; }
    .field-chip {
      font-size:13px; background:#f9fafb; border:1px solid var(--border); border-radius: 12px; padding:6px 8px; display:flex; align-items:center; gap:6px; user-select: none;
    }
    [data-theme="dark"] .field-chip { background: #334155; }
    .field-chip input { margin:0; }
    .toolbar { display:flex; gap: 8px; align-items:center; flex-wrap:wrap; }
    .spacer { flex: 1; }
    .chart-wrap { height: 320px; position: relative; }
    .overflow { overflow:auto; max-height: 480px; }
    .count { font-weight:600; }
    footer { text-align:center; color: var(--muted); font-size: 12px; padding: 16px 0; }
    .dropzone {
      border:2px dashed var(--border); border-radius:16px; padding:24px; text-align:center; color:var(--muted); cursor: pointer; transition: all 0.2s;
    }
    .dropzone.drag { border-color: var(--accent); color: var(--accent); background: #eef2ff; }
    .file-list { margin-top: 12px; display: flex; flex-direction: column; gap: 6px; }
    .file-item {
      display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: #f1f5f9; border-radius: 8px; font-size: 13px;
    }
    [data-theme="dark"] .file-item { background: #334155; }
    .loader { display: inline-block; width: 16px; height: 16px; border: 2px solid #e2e8f0; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .toast {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 20px; border-radius: 12px; background: #1e293b; color: #fff; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; opacity: 0; transition: opacity 0.3s;
    }
    .toast.show { opacity: 1; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Product Explorer</h1>
        <p class="muted">Upload files or <strong>paste data</strong> → filter trigger & upsell → export</p>
      </div>
      <div class="toolbar">
        <input id="fileInput" type="file" accept=".txt,.json,.rtf,.pdf" multiple hidden />
        <button class="btn" id="uploadBtn" aria-label="Upload files">
          <span class="icon">Upload</span> Upload
        </button>
        <button class="btn" id="exportBtn" disabled>Export CSV</button>
        <button class="btn sm" id="copyBtn" disabled title="Copy table to clipboard">Copy</button>
        <button class="btn sm" id="clearFiltersBtn" disabled>Clear</button>
        <button class="btn sm" id="themeBtn" aria-label="Toggle dark mode">Dark</button>
      </div>
    </header>

    <!-- Paste Data Section -->
    <section class="row" style="margin-bottom:12px;">
      <div class="card pad controls" style="grid-column: span 12;">
        <label for="pasteInput">Paste JSON / Text / RTF</label>
        <textarea id="pasteInput" placeholder='Paste your data here (e.g. JSON array of products, or raw text)...'></textarea>
        <div style="margin-top:8px;">
          <button class="btn sm" id="parsePasteBtn">Parse Pasted Data</button>
          <span class="muted" style="margin-left:8px; font-size:12px;">Supports JSON, plain text, RTF</span>
        </div>
      </div>
    </section>

    <section class="row" style="margin-bottom:12px;">
      <div class="card pad controls" style="grid-column: span 12; @media (min-width: 768px) { grid-column: span 8; }">
        <div id="dropzone" class="dropzone">Drag & drop files here or click “Upload”</div>
        <div id="fileList" class="file-list"></div>
      </div>
      <div class="card pad controls" style="grid-column: span 12; @media (min-width: 768px) { grid-column: span 4; }">
        <label for="searchInput">Quick search</label>
        <input id="searchInput" type="text" placeholder="Title, vendor, tags, id, trigger, upsell..." />
      </div>
    </section>

    <section class="row" style="margin-bottom:12px;">
      <div class="card pad controls" style="grid-column: span 6; @media (min-width: 640px) { grid-column: span 3; }">
        <label for="vendorSelect">Vendor</label>
        <select id="vendorSelect"><option value="">All</option></select>
      </div>
      <div class="card pad controls" style="grid-column: span 6; @media (min-width: 640px) { grid-column: span 3; }">
        <label for="availSelect">Availability</label>
        <select id="availSelect">
          <option value="">All</option>
          <option value="true">Available</option>
          <option value="false">Unavailable</option>
        </select>
      </div>
      <div class="card pad controls" style="grid-column: span 6; @media (min-width: 640px) { grid-column: span 3; }">
        <label for="minPrice">Min Price</label>
        <input id="minPrice" type="number" placeholder="e.g. 20" />
      </div>
      <div class="card pad controls" style="grid-column: span 6; @media (min-width: 640px) { grid-column: span 3; }">
        <label for="maxPrice">Max Price</label>
        <input id="maxPrice" type="number" placeholder="e.g. 100" />
      </div>
    </section>

    <section class="row" style="margin-bottom:12px;">
      <div class="card pad" style="grid-column: span 12;">
        <label style="font-size:13px; color:var(--muted); display:block; margin-bottom:6px;">Fields to show</label>
        <div id="fieldChooser" class="chips"></div>
        <div id="quickBtns" style="margin-top:8px;"></div>
      </div>
    </section>

    <section class="row" style="margin-bottom:12px;">
      <div class="card pad" style="grid-column: span 12;">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px; flex-wrap: wrap;">
          <div style="font-size:18px; font-weight:600;">Inventory by product</div>
          <div class="spacer"></div>
          <div class="muted" id="countLabel">0 products</div>
        </div>
        <div class="chart-wrap"><canvas id="chart"></canvas></div>
      </div>
    </section>

    <section class="row">
      <div class="card pad" style="grid-column: span 12;">
        <div class="overflow">
          <table id="table" aria-describedby="countLabel">
            <thead><tr id="tableHead"></tr></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <footer>Built client-side. Your data never leaves the browser. <span id="version">v2.2</span></footer>
  </div>
  <div class="toast" id="toast"></div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  <!-- pdf.js -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";

    const state = {
      rows: [], filtered: [], selectedFields: ["product_title","product_vendor","price_min","price_max","inventory_total","available"],
      sort: { field: null, asc: true }, chart: null, files: [], processing: false
    };

    const els = {
      fileInput: document.getElementById('fileInput'),
      uploadBtn: document.getElementById('uploadBtn'),
      exportBtn: document.getElementById('exportBtn'),
      copyBtn: document.getElementById('copyBtn'),
      clearFiltersBtn: document.getElementById('clearFiltersBtn'),
      themeBtn: document.getElementById('themeBtn'),
      dropzone: document.getElementById('dropzone'),
      fileList: document.getElementById('fileList'),
      searchInput: document.getElementById('searchInput'),
      vendorSelect: document.getElementById('vendorSelect'),
      availSelect: document.getElementById('availSelect'),
      minPrice: document.getElementById('minPrice'),
      maxPrice: document.getElementById('maxPrice'),
      fieldChooser: document.getElementById('fieldChooser'),
      quickBtns: document.getElementById('quickBtns'),
      tableHead: document.getElementById('tableHead'),
      tableBody: document.getElementById('tableBody'),
      countLabel: document.getElementById('countLabel'),
      chart: document.getElementById('chart'),
      toast: document.getElementById('toast'),
      pasteInput: document.getElementById('pasteInput'),
      parsePasteBtn: document.getElementById('parsePasteBtn')
    };

    // ========== UTILS ==========
    function showToast(msg, type = 'info', duration = 3000) {
      els.toast.textContent = msg;
      els.toast.className = `toast show`;
      setTimeout(() => els.toast.className = 'toast', duration);
    }

    function sanitizeRTFKeepJSON(rtf) {
      let s = rtf
        .replace(/\\par[d]?/g, '\n')
        .replace(/\\'[0-9a-fA-F]{2}/g, ' ')
        .replace(/\\([a-zA-Z]+)([\-\d]+)? ?/g, '')
        .replace(/\\{/g, '{').replace(/\\}/g, '}')
        .replace(/\\\\/g, '')
        .replace(/\n\s*\n/g, '\n')
        .trim();
      return s;
    }

    function extractJSON(text) {
      try { return JSON.parse(text); } catch {}
      const patterns = [ /\[\s*\{/, /{\s*"(id|product_id|trigger_set|products)"/ ];
      for (const regex of patterns) {
        const match = regex.exec(text);
        if (match) {
          const start = match.index;
          const slice = balancedSlice(text, start);
          if (slice) {
            try { return JSON.parse(slice); } catch {}
          }
        }
      }
      return null;
    }

    function balancedSlice(s, start) {
      const stack = []; const pairs = { '[': ']', '{': '}' };
      for (let i = start; i < s.length; i++) {
        const ch = s[i];
        if (pairs[ch]) stack.push(ch);
        else if (Object.values(pairs).includes(ch)) {
          if (!stack.length || pairs[stack.pop()] !== ch) return null;
          if (!stack.length) return s.slice(start, i + 1);
        }
      }
      return null;
    }

    async function pdfToText(file) {
      const arrayBuffer = await file.arrayBuffer();
      const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
      const pdf = await loadingTask.promise;
      let full = "";
      for (let p = 1; p <= pdf.numPages; p++) {
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();
        const strings = content.items.map(item => item.str);
        full += strings.join(" ") + "\n";
      }
      return full.trim();
    }

    function asNumber(v) {
      if (v === undefined || v === null || v === "") return null;
      const n = typeof v === "number" ? v : Number(String(v).replace(/[^\d.\-]/g, ""));
      return isNaN(n) ? null : n;
    }

    function deriveProductRow(p, source) {
      const variants = Array.isArray(p.variants) ? p.variants :
                       Array.isArray(p.product_variants) ? p.product_variants : [];
      const prices = variants.map(v => asNumber(v.price || v.variant_price)).filter(v => v !== null);
      const inv = variants.map(v => asNumber(v.inventory_quantity || v.inventory)).filter(v => v !== null);
      const available = variants.some(v => v.available ?? v.variant_available ?? false);

      const trigger = p.trigger_set
        ? (Array.isArray(p.trigger_set) ? p.trigger_set.join(', ') : String(p.trigger_set))
        : null;

      const upsell = p.upsell_products || p.upsells
        ? (Array.isArray(p.upsell_products) ? p.upsell_products.map(u=>u.title||u.id).join(', ')
           : Array.isArray(p.upsells) ? p.upsells.map(u=>u.title||u.id).join(', ')
           : null)
        : null;

      return {
        source,
        product_id: p.id || p.product_id,
        product_title: p.title || p.product_title || p.name,
        product_description: p.body_html || p.description || p.product_description,
        product_handle: p.handle || p.product_handle,
        product_vendor: p.vendor || p.product_vendor,
        product_tags: Array.isArray(p.tags) ? p.tags : (p.product_tags || '').split(',').map(t => t.trim()).filter(Boolean),
        product_url: p.online_store_url || p.product_url,
        product_image: p.image?.src || p.images?.[0]?.src || p.product_image,
        price_min: prices.length ? Math.min(...prices) : null,
        price_max: prices.length ? Math.max(...prices) : null,
        inventory_total: inv.length ? inv.reduce((a,b) => a + b, 0) : null,
        available,
        trigger,
        upsell
      };
    }

    function flattenAnyJSON(data) {
      const rows = [];
      const process = (obj, src) => {
        if (Array.isArray(obj)) obj.forEach(o => process(o, src));
        else if (obj && typeof obj === 'object') {
          if (obj.id || obj.product_id || obj.title) rows.push(deriveProductRow(obj, src));
          else Object.values(obj).forEach(v => process(v, src));
        }
      };
      process(data, "pasted");
      return rows.length ? rows : [deriveProductRow(data, "raw")];
    }

    // ========== UI ==========
    const unique = arr => Array.from(new Set(arr));
    const escapeHtml = s => String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;");

    function getAllFields(rows) {
      const s = new Set();
      rows.forEach(r => Object.keys(r).forEach(k => s.add(k)));
      return Array.from(s).sort();
    }

    function renderFileList() {
      els.fileList.innerHTML = state.files.map((f, i) => `
        <div class="file-item">
          <span title="${escapeHtml(f.file?.name || 'Pasted Data')}">${escapeHtml(f.file?.name || 'Pasted Data')} (${f.status})</span>
          <button class="btn sm danger" onclick="removeFile(${i})" ${state.processing ? 'disabled' : ''}>Remove</button>
        </div>
      `).join('');
    }

    window.removeFile = (i) => {
      state.files.splice(i, 1);
      state.rows = state.files.filter(f => f.status === 'success').flatMap(f => f.rows);
      renderFieldChooser(); renderVendors(); renderTable();
    };

    function renderFieldChooser() {
      const allFields = getAllFields(state.rows);
      els.fieldChooser.innerHTML = "";
      allFields.forEach(f => {
        const lbl = document.createElement("label");
        lbl.className = "field-chip";
        const cb = document.createElement("input");
        cb.type = "checkbox"; cb.checked = state.selectedFields.includes(f);
        cb.addEventListener("change", () => {
          state.selectedFields = cb.checked
            ? unique([...state.selectedFields, f])
            : state.selectedFields.filter(x => x !== f);
          renderTable();
        });
        const span = document.createElement("span");
        span.textContent = f;
        lbl.appendChild(cb); lbl.appendChild(span);
        els.fieldChooser.appendChild(lbl);
      });
      renderQuickButtons();
    }

    function renderQuickButtons() {
      if (els.quickBtns.querySelector('.quick-btns')) return;
      const btns = document.createElement('div');
      btns.className = 'quick-btns';
      btns.innerHTML = `
        <button class="btn sm" id="showTriggerOnly">Trigger only</button>
        <button class="btn sm" id="showUpsellOnly">Upsell only</button>
        <button class="btn sm" id="showBoth">Trigger + Upsell</button>
      `;
      els.quickBtns.appendChild(btns);

      document.getElementById('showTriggerOnly').onclick = () => setFields(['trigger']);
      document.getElementById('showUpsellOnly').onclick = () => setFields(['upsell']);
      document.getElementById('showBoth').onclick = () => setFields(['trigger','upsell']);
    }

    function setFields(wanted) {
      state.selectedFields = wanted;
      document.querySelectorAll('#fieldChooser input[type=checkbox]').forEach(cb => {
        cb.checked = wanted.includes(cb.parentElement.textContent.trim());
      });
      renderTable();
    }

    function renderVendors() {
      const vendors = unique(state.rows.map(r => r.product_vendor).filter(Boolean));
      els.vendorSelect.innerHTML = "<option value=''>All</option>" +
        vendors.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
    }

    function filterAndSort() {
      let filtered = state.rows;
      const query = els.searchInput.value.trim().toLowerCase();
      if (query) {
        filtered = filtered.filter(r =>
          JSON.stringify(Object.values(r)).toLowerCase().includes(query)
        );
      }
      const vendor = els.vendorSelect.value;
      const avail = els.availSelect.value;
      const min = asNumber(els.minPrice.value);
      const max = asNumber(els.maxPrice.value);
      if (vendor) filtered = filtered.filter(r => r.product_vendor === vendor);
      if (avail !== "") filtered = filtered.filter(r => String(r.available) === avail);
      if (min !== null || max !== null) {
        filtered = filtered.filter(r => {
          const p = r.price_min ?? r.price_max ?? 0;
          return (min === null || p >= min) && (max === null || p <= max);
        });
      }
      if (state.sort.field) {
        filtered.sort((a, b) => {
          let av = a[state.sort.field], bv = b[state.sort.field];
          if (av == null) av = ""; if (bv == null) bv = "";
          const result = String(av).localeCompare(String(bv), undefined, {numeric: true});
          return state.sort.asc ? result : -result;
        });
      }
      state.filtered = filtered;
      els.countLabel.textContent = `${state.filtered.length} product${state.filtered.length === 1 ? '' : 's'}`;
      els.exportBtn.disabled = state.filtered.length === 0;
      els.copyBtn.disabled = state.filtered.length === 0;
      els.clearFiltersBtn.disabled = !query && !vendor && avail === "" && min === null && max === null;
    }

    function renderTable() {
      filterAndSort();
      els.tableHead.innerHTML = state.selectedFields.map(f => {
        const sorted = state.sort.field === f;
        return `<th onclick="sortBy('${f}')">
          ${escapeHtml(f)}
          ${sorted ? (state.sort.asc ? ' up' : ' down') : ''}
        </th>`;
      }).join("");
      const rowsHtml = state.filtered.length ? state.filtered.map(r => {
        return "<tr>" + state.selectedFields.map(f => {
          let val = r[f];
          if (f === "product_image" && val) {
            return `<td><img src="${escapeHtml(val)}" alt="" style="width:48px;height:48px;object-fit:cover;border-radius:8px;" loading="lazy"/></td>`;
          } else if (f === "product_url" && val) {
            return `<td><a href="${escapeHtml(val)}" target="_blank" rel="noopener">link</a></td>`;
          } else if (f === "product_tags" && Array.isArray(val)) {
            const chips = val.slice(0, 6).map(t => `<span class="pill">${escapeHtml(t)}</span>`).join("");
            const more = val.length > 6 ? `<span class="muted">+${val.length - 6}</span>` : "";
            return `<td>${chips} ${more}</td>`;
          } else if (typeof val === "boolean") {
            return `<td style="color:${val ? 'var(--success)' : 'var(--danger)'}">${val}</td>`;
          } else if (val === null || val === undefined) {
            return `<td></td>`;
          } else if (typeof val === "object") {
            return `<td><code style="font-size:12px">${escapeHtml(JSON.stringify(val).slice(0, 100))}</code></td>`;
          }
          return `<td>${escapeHtml(String(val))}</td>`;
        }).join("") + "</tr>";
      }).join("") : `<tr><td colspan="${state.selectedFields.length}" style="text-align:center; color:var(--muted); padding:32px;">
        No products match your filters. Try adjusting them or paste/upload new data.
      </td></tr>`;
      els.tableBody.innerHTML = rowsHtml;
      renderChart();
    }

    window.sortBy = (field) => {
      if (state.sort.field === field) {
        state.sort.asc = !state.sort.asc;
      } else {
        state.sort.field = field;
        state.sort.asc = true;
      }
      renderTable();
    };

    function renderChart() {
      const labels = state.filtered.map(r => (r.product_title || r.product_id || "Unknown").slice(0, 20));
      const data = state.filtered.map(r => r.inventory_total ?? 0);
      if (state.chart) state.chart.destroy();
      state.chart = new Chart(els.chart.getContext("2d"), {
        type: "bar",
        data: { labels, datasets: [{ label: "Inventory", data, backgroundColor: "rgba(37, 99, 235, 0.7)" }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { enabled: true } },
          scales: { x: { ticks: { maxRotation: 45, minRotation: 45, font: { size: 11 } } }, y: { beginAtZero: true } }
        }
      });
    }

    function csvEscape(val) {
      if (val === null || val === undefined) return "";
      const s = typeof val === "object" ? JSON.stringify(val) : String(val);
      return /[\,"'\n\r]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
    }

    function exportCSV() {
      const header = state.selectedFields.join(",");
      const body = state.filtered.map(r => state.selectedFields.map(f => csvEscape(r[f])).join(",")).join("\n");
      const csv = header + "\n" + body;
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `products-${new Date().toISOString().slice(0,10)}.csv`; a.click();
      URL.revokeObjectURL(url);
      showToast("CSV exported!", "success");
    }

    async function copyTable() {
      const text = [state.selectedFields.join("\t"), ...state.filtered.map(r =>
        state.selectedFields.map(f => csvEscape(r[f])).join("\t")
      )].join("\n");
      try {
        await navigator.clipboard.writeText(text);
        showToast("Table copied to clipboard!", "success");
      } catch (err) {
        showToast("Copy failed", "error");
      }
    }

    // ========== PASTE HANDLING ==========
    els.parsePasteBtn.addEventListener("click", async () => {
      const text = els.pasteInput.value.trim();
      if (!text) {
        showToast("Paste some data first!", "warning");
        return;
      }
      state.processing = true;
      els.parsePasteBtn.disabled = true;
      els.parsePasteBtn.innerHTML = '<span class="loader"></span> Parsing...';

      try {
        let parsed = extractJSON(text);
        let rows = parsed ? flattenAnyJSON(parsed) : [];
        const entry = { file: null, status: rows.length ? 'success' : 'empty', rows };
        state.files.push(entry);
        state.rows = state.files.filter(f => f.status === 'success').flatMap(f => f.rows);
        renderFileList(); renderFieldChooser(); renderVendors(); renderTable();
        showToast(`Pasted data: ${rows.length} products`, rows.length ? 'success' : 'warning');
        els.pasteInput.value = '';
      } catch (err) {
        showToast("Failed to parse pasted data", "error");
        console.error(err);
      } finally {
        state.processing = false;
        els.parsePasteBtn.disabled = false;
        els.parsePasteBtn.innerHTML = 'Parse Pasted Data';
      }
    });

    // ========== FILE HANDLING ==========
    async function handleFiles(files) {
      if (!files.length) return;
      state.processing = true;
      els.uploadBtn.disabled = true;
      els.uploadBtn.innerHTML = '<span class="loader"></span> Processing...';
      const newFiles = Array.from(files).map(file => ({ file, status: 'pending', rows: [] }));
      state.files.push(...newFiles);
      renderFileList();

      for (const entry of newFiles) {
        try {
          const ext = (entry.file.name.split(".").pop() || "").toLowerCase();
          let text = await new FileReader().readAsText(entry.file);
          if (ext === "rtf") text = sanitizeRTFKeepJSON(text);
          if (ext === "pdf") text = await pdfToText(entry.file);
          const parsed = extractJSON(text);
          const rows = parsed ? flattenAnyJSON(parsed) : [];
          entry.rows = rows;
          entry.status = rows.length ? 'success' : 'empty';
          showToast(`${entry.file.name}: ${rows.length} products`, rows.length ? 'success' : 'warning');
        } catch (err) {
          entry.status = 'error';
          showToast(`${entry.file.name}: Failed to parse`, 'error');
          console.error(err);
        }
      }
      state.rows = state.files.filter(f => f.status === 'success').flatMap(f => f.rows);
      renderFieldChooser(); renderVendors(); renderTable();
      renderFileList();
      state.processing = false;
      els.uploadBtn.disabled = false;
      els.uploadBtn.innerHTML = 'Upload';
    }

    // ========== EVENTS ==========
    ["dragenter","dragover"].forEach(ev => els.dropzone.addEventListener(ev, e => {
      e.preventDefault(); els.dropzone.classList.add("drag");
    }));
    ["dragleave","drop"].forEach(ev => els.dropzone.addEventListener(ev, e => {
      e.preventDefault(); els.dropzone.classList.remove("drag");
    }));
    els.dropzone.addEventListener("drop", e => handleFiles(e.dataTransfer.files));
    els.dropzone.addEventListener("click", () => els.fileInput.click());
    els.uploadBtn.addEventListener("click", () => els.fileInput.click());
    els.fileInput.addEventListener("change", e => handleFiles(Array.from(e.target.files || [])));
    els.exportBtn.addEventListener("click", exportCSV);
    els.copyBtn.addEventListener("click", copyTable);
    els.clearFiltersBtn.addEventListener("click", () => {
      els.searchInput.value = "";
      els.vendorSelect.value = "";
      els.availSelect.value = "";
      els.minPrice.value = "";
      els.maxPrice.value = "";
      renderTable();
    });
    [els.searchInput, els.vendorSelect, els.availSelect, els.minPrice, els.maxPrice].forEach(el =>
      el.addEventListener("input", () => setTimeout(renderTable, 100))
    );
    els.themeBtn.addEventListener("click", () => {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
      els.themeBtn.textContent = isDark ? 'Dark' : 'Light';
    });

    // Initial
    renderTable();
  </script>
</body>
</html>
